<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${board.title}">Доска</title>
    <link rel="stylesheet" th:href="@{/css/pico.classless.blue.min.css}">
    <style>
        html, body { height:100%; }
        body { padding:0.6rem; }
        header { display:flex; align-items:center; gap:.6rem; margin-bottom:0.6rem }
        .back-btn { padding:0.4rem 0.6rem; border-radius:8px; display:inline-flex; align-items:center; gap:0.4rem; }
        .back-icon { width:18px; height:18px; display:inline-block; vertical-align:middle; }
        .board-top { display:flex; gap:0.5rem; align-items:center; justify-content:space-between; }
        .board-top strong { font-size:1.6rem; font-weight:800; }

        .stack { display:flex; flex-direction:column; gap:0.25rem; }
        main.container { height: calc(100vh - 88px); overflow-y: auto; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .section { border-radius:10px; padding:0.45rem 0.5rem; background:var(--surface-1); box-shadow:0 4px 10px rgba(0,0,0,0.03); scroll-snap-align:start; }
        .section + .section { margin-top:0.12rem; }
        .section-title { font-weight:700; margin:0 0 0.25rem 0; font-size:1rem; }

        .card-item { display:block; width:100%; box-sizing:border-box; padding:0.5rem 0.6rem; border-radius:8px; margin-bottom:0.18rem; box-shadow:0 4px 12px rgba(0,0,0,0.04); font-size:0.85rem; line-height:1.2; text-align:left; }

        .todo .card-item { background: linear-gradient(180deg, #fff0f0, #ffd6d6); color: #7a0d0d; }
        .progress .card-item { background: linear-gradient(180deg, #fffdf0, #fff2c4); color: #7a5a00; }
        .done .card-item { background: linear-gradient(180deg, #f0fff2, #d6ffd6); color: #0b6d2d; }

        .btn-todo { background:#ff5c5c; color:white; border:none; border-radius:6px; padding:0.45rem; }
        .btn-progress { background:#ffb400; color:white; border:none; border-radius:6px; padding:0.45rem; }
        .btn-done { background:#2d9d4a; color:white; border:none; border-radius:6px; padding:0.45rem; }

        .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; z-index:900; }
        #overlay, #overlayCreate { background: rgba(0,0,0,0.95); }
        .menu { position:fixed; display:none; background: linear-gradient(180deg, var(--surface-0), #ffffff); padding:0.8rem; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,0.18); z-index:1000; width:320px; max-width:calc(100% - 32px); }
        .menu form{ margin:0; }
        .menu button{ display:block; width:100%; margin:0.35rem 0; }

        .fab { position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:50%; background:#0066ff; color:white; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(0,0,0,0.2); border:none; z-index:1100; }
        .fab:active{ transform:translateY(1px); }

        @media (max-width:699px) {
            #menu, #createModal {
                left: 50%;
                transform: translateX(-50%);
                top: 6%;
                right: auto;
                bottom: auto;
                width: calc(100% - 32px);
                max-width: 420px;
            }
        }

        @media (min-width:700px){
            main.container { height: calc(100vh - 120px); }
            .container { max-width:900px; margin:0 auto; }
        }
    </style>
</head>
<body>
<header>
    <div class="board-top">
        <div style="display:flex; align-items:center; gap:0.6rem;">
            <a class="back-btn" th:href="@{/cardboards}">
                <svg class="back-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </a>
            <strong th:text="${board.title}">Название доски</strong>
        </div>
    </div>
</header>
<main class="container">
    <section class="stack">
        <div class="section todo">
            <h3 class="section-title" style="display:flex; align-items:center; gap:0.45rem;">
                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="8" cy="8" r="7" fill="#ff5c5c"/></svg>
                TODO
            </h3>
            <div th:each="card : ${board.cards}" th:if="${card.status.name() == 'TODO'}">
                <div class="card-item"
                     th:attr="data-cardid=${card.uuid}, data-boardid=${board.uuid}"
                     th:text="${card.text}"
                     onclick="openMenuFromElement(event, this)">Карточка</div>
            </div>
        </div>

        <div class="section progress">
            <h3 class="section-title" style="display:flex; align-items:center; gap:0.45rem;">
                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="8" cy="8" r="7" fill="#ffb400"/></svg>
                IN PROGRESS
            </h3>
            <div th:each="card : ${board.cards}" th:if="${card.status.name() == 'PROGRESS'}">
                <div class="card-item"
                     th:attr="data-cardid=${card.uuid}, data-boardid=${board.uuid}"
                     th:text="${card.text}"
                     onclick="openMenuFromElement(event, this)">Карточка</div>
            </div>
        </div>

        <div class="section done">
            <h3 class="section-title" style="display:flex; align-items:center; gap:0.45rem;">
                <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="8" cy="8" r="7" fill="#2d9d4a"/></svg>
                READY
            </h3>
            <div th:each="card : ${board.cards}" th:if="${card.status.name() == 'DONE'}">
                <div class="card-item"
                     th:attr="data-cardid=${card.uuid}, data-boardid=${board.uuid}"
                     th:text="${card.text}"
                     onclick="openMenuFromElement(event, this)">Карточка</div>
            </div>
        </div>
    </section>
</main>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>
<div class="menu" id="menu">
    <form id="editForm" method="post" style="display:none;">
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <label for="editText">Новый текст</label>
        <input type="text" name="text" id="editText" style="width:100%; margin-top:0.4rem;" />
        <div style="display:flex; gap:0.4rem; margin-top:0.5rem; justify-content:space-between; align-items:center;">
            <div style="display:flex; gap:0.25rem;">
                <button type="button" class="btn-todo" onclick="moveCard('TODO')" title="Переместить в TODO" style="padding:6px; border-radius:6px; border:none; background:transparent;">
                    <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="8" cy="8" r="7" fill="#ff5c5c"/></svg>
                </button>
                <button type="button" class="btn-progress" onclick="moveCard('PROGRESS')" title="В ПРОЦЕССЕ" style="padding:6px; border-radius:6px; border:none; background:transparent;">
                    <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="8" cy="8" r="7" fill="#ffb400"/></svg>
                </button>
                <button type="button" class="btn-done" onclick="moveCard('DONE')" title="ГОТОВО" style="padding:6px; border-radius:6px; border:none; background:transparent;">
                    <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="8" cy="8" r="7" fill="#2d9d4a"/></svg>
                </button>
            </div>
            <div style="display:flex; gap:0.25rem;">
                <button type="submit" title="Сохранить" style="background:transparent; border:none; padding:6px; border-radius:6px; color:#0066ff;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M20 6L9 17l-5-5" stroke="#0066ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
                </button>
                <button type="button" onclick="deleteCard()" title="Удалить" style="background:transparent; border:none; padding:6px; border-radius:6px; color:#c0392b;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </form>
    <div id="moveActions" style="display:none;">
        <form id="moveForm" method="post">
            <input type="hidden" name="status" id="moveStatus" />
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
    </div>
    <div style="margin-top:0.5rem; text-align:right;"><button onclick="closeMenu()">Закрыть</button></div>
</div>

<form id="createForm" th:action="@{/cardboard/{boardId}/card/create(boardId=${board.uuid})}" method="post" style="display:none;">
    <input type="hidden" name="text" id="createText" />
    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
</form>

<div class="overlay" id="overlayCreate" onclick="closeCreateModal()" style="display:none;"></div>
<div class="menu" id="createModal" style="display:none; width:calc(100% - 40px); max-width:420px; left:50%; transform:translateX(-50%); top:6%; right:auto; bottom:auto;">
    <form id="createModalForm" method="post" th:action="@{/cardboard/{boardId}/card/create(boardId=${board.uuid})}">
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <label for="createInput">Текст карточки</label>
        <input id="createInput" name="text" type="text" placeholder="Введите текст карточки" style="width:100%; margin-top:0.4rem; padding:0.6rem; border-radius:8px;" />
        <div style="display:flex; gap:0.4rem; margin-top:0.6rem; justify-content:flex-end;">
            <button type="button" onclick="closeCreateModal()">Отмена</button>
            <button type="submit" style="background:#0066ff; color:white;">Создать</button>
        </div>
    </form>
</div>

<button class="fab" onclick="openCreateModal()" aria-label="Создать">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 5v14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>
<script>
    let currentBoardId = null;
    let currentCardId = null;
    function openMenuFromElement(e, el){
        if (e && e.stopPropagation) e.stopPropagation();
        currentBoardId = el.dataset.boardid;
        currentCardId = el.dataset.cardid;
        document.getElementById('overlay').style.display='block';
        document.getElementById('menu').style.display='block';
        const editForm = document.getElementById('editForm');
        editForm.style.display='block';
        editForm.action = `/cardboard/${currentBoardId}/card/${currentCardId}/edit`;
        document.getElementById('editText').value = el.innerText.trim();
        const moveForm = document.getElementById('moveForm');
        moveForm.action = `/cardboard/${currentBoardId}/card/${currentCardId}/move`;
        setTimeout(()=>document.getElementById('editText').focus(),50);
    }
    function closeMenu(){
        document.getElementById('overlay').style.display='none';
        document.getElementById('menu').style.display='none';
        document.getElementById('editForm').style.display='none';
        document.getElementById('moveActions').style.display='none';
    }
    function moveCard(status){
        const moveForm = document.getElementById('moveForm');
        document.getElementById('moveStatus').value = status;
        moveForm.submit();
    }
    function deleteCard(){
        if (!currentBoardId || !currentCardId) return;
        const form = document.createElement('form');
        form.method = 'post';
        form.action = `/cardboard/${currentBoardId}/card/${currentCardId}/delete`;
        const csrf = document.querySelector('#menu input[type=hidden][name]');
        if (csrf) {
            const inp = document.createElement('input');
            inp.type = 'hidden';
            inp.name = csrf.name;
            inp.value = csrf.value;
            form.appendChild(inp);
        }
        document.body.appendChild(form);
        form.submit();
    }
    function openCreateModal(){
        document.getElementById('createInput').value = '';
        document.getElementById('overlayCreate').style.display = 'block';
        document.getElementById('createModal').style.display = 'block';
        setTimeout(()=>document.getElementById('createInput').focus(),50);
    }
    function closeCreateModal(){
        document.getElementById('overlayCreate').style.display = 'none';
        document.getElementById('createModal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function(){
        const params = new URLSearchParams(window.location.search);
        const open = params.get('openCard');
        if (open) {
            const url = new URL(window.location);
            url.searchParams.delete('openCard');
            history.replaceState({}, '', url.pathname + url.search);
            setTimeout(function(){
                const el = document.querySelector('[data-cardid="' + open + '"]');
                if (el) {
                    openMenuFromElement({stopPropagation: function(){}}, el);
                }
            }, 120);
        }
    });
</script>

</body>
</html>
